name: API Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r monitor/requirements.txt

      - name: Run monitor
        run: |
          python monitor/monitor.py

      - name: Create/Close Issues based on alerts + recoveries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python - <<'PY'
          import json, os, urllib.request

          alerts_path = "docs/data/alerts.json"
          recoveries_path = "docs/data/recoveries.json"
          state_path = "docs/data/state.json"

          with open(alerts_path, "r", encoding="utf-8") as f:
            alerts = json.load(f).get("alerts", [])

          with open(recoveries_path, "r", encoding="utf-8") as f:
            recoveries = json.load(f).get("recoveries", [])

          with open(state_path, "r", encoding="utf-8") as f:
            state = json.load(f)

          def gh_api(method, url, data=None):
            token = os.environ["GH_TOKEN"]
            req = urllib.request.Request(
              url,
              method=method,
              headers={
                "Authorization": f"Bearer {token}",
                "Accept": "application/vnd.github+json",
                "User-Agent": "api-observability-mini-lab",
              },
              data=(json.dumps(data).encode("utf-8") if data else None)
            )
            with urllib.request.urlopen(req) as resp:
              return json.loads(resp.read().decode("utf-8"))

          repo = os.environ["REPO"]
          created = 0
          closed = 0

          # ---- Create issues for alerts ----
          for a in alerts:
            url_key = a["url"]
            if url_key in state.get("open_alerts", {}):
              continue

            title = f"[ALERT] {a['name']} failing ({a['streak']} consecutive checks)"
            body = "\n".join([
